# ğŸ¯ P0 é˜¶æ®µå¼€å‘æŒ‡å— - æ ¸å¿ƒä½“éªŒ

> **é˜¶æ®µç›®æ ‡**: å»ºç«‹æ•°æ®æŒä¹…åŒ–åŸºç¡€è®¾æ–½å’Œæ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘æ‰“ä¸‹åŸºç¡€
>
> **å®é™…å‘¨æœŸ**: 2 å¤© (2026-01-03 ~ 2026-01-04)
>
> **çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ
>
> **å…³è” Issue**: [#16 - ç¥ç¬”é©¬è‰¯ 2.0 ç‰ˆæœ¬è§„åˆ’](https://github.com/qqyule/soul-canvas-ai/issues/16)

---

## ğŸ“‹ å¼€å‘é¡ºåºä¸ä¾èµ–å…³ç³»

```mermaid
graph TD
    A[1. Neon æ•°æ®åº“é›†æˆ] --> B[2. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ]
    B --> C[6. è‰ç¨¿è‡ªåŠ¨ä¿å­˜]
    D[3. AI æ‰§è¡Œå®¹é”™æ€§] --> E[5. å±€éƒ¨é‡ç»˜åŠŸèƒ½]
    F[4. ç”»æ¿å›¾å±‚ç³»ç»Ÿ] --> E
```

> [!IMPORTANT] > **å¼ºçƒˆå»ºè®®æŒ‰ç…§ä¸Šè¿°é¡ºåºå¼€å‘**ï¼Œå› ä¸ºå­˜åœ¨ä¾èµ–å…³ç³»ï¼š
>
> - ç”¨æˆ·è®¤è¯ä¾èµ–æ•°æ®åº“
> - è‰ç¨¿ä¿å­˜ä¾èµ–ç”¨æˆ·ç³»ç»Ÿ
> - å±€éƒ¨é‡ç»˜ä¾èµ–å›¾å±‚ç³»ç»Ÿå’Œ AI å®¹é”™

---

## 1ï¸âƒ£ Neon æ•°æ®åº“é›†æˆ

**åˆ†æ”¯**: `feature/neon-database`

**çŠ¶æ€**: âœ… å·²å®Œæˆ

### åŠŸèƒ½èŒƒå›´

- [x] Neon PostgreSQL æ¥å…¥é…ç½®
- [x] æ ¸å¿ƒæ•°æ®æ¨¡å‹è®¾è®¡
  - users (ç”¨æˆ·è¡¨)
  - artworks (ä½œå“è¡¨)
  - custom-styles (è‡ªå®šä¹‰é£æ ¼è¡¨)
  - favorites (æ”¶è—è¡¨)
  - generation_logs (ç”Ÿæˆæ—¥å¿—è¡¨)
- [x] Drizzle ORM é›†æˆ
- [x] åŸºç¡€ CRUD æ“ä½œå°è£… (Repository æ¨¡å¼)
- [x] ç¯å¢ƒå˜é‡é…ç½®
- [x] Zod éªŒè¯ Schema
- [x] å•å…ƒæµ‹è¯• (validators + repositories)

### æŠ€æœ¯è¦ç‚¹

```typescript
// æ¨èçš„ä¾èµ–
pnpm add @neondatabase/serverless drizzle-orm
pnpm add -D drizzle-kit
```

### å¼€å‘æ­¥éª¤

1. æ³¨å†Œ Neon è´¦æˆ·ï¼Œåˆ›å»ºæ•°æ®åº“å®ä¾‹
2. é…ç½®è¿æ¥å­—ç¬¦ä¸²åˆ° `.env.local`
3. è®¾è®¡å¹¶åˆ›å»ºæ•°æ®åº“ schema
4. å®ç° Drizzle ORM é…ç½®
5. åˆ›å»ºåŸºç¡€æ•°æ®åº“æ“ä½œå·¥å…·å‡½æ•°
6. ç¼–å†™å•å…ƒæµ‹è¯•

### éªŒæ”¶æ ‡å‡†

- [x] æ•°æ®åº“è¿æ¥æˆåŠŸ
- [x] åŸºç¡€è¡¨ç»“æ„åˆ›å»ºå®Œæˆ
- [x] CRUD æ“ä½œæ­£å¸¸å·¥ä½œ
- [x] è¿ç§»è„šæœ¬å¯ç”¨

---

## 2ï¸âƒ£ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (Auth)

**åˆ†æ”¯**: `feature/user-auth`

**çŠ¶æ€**: âœ… å·²å®Œæˆ

**ä¾èµ–**: `feature/neon-database`

### åŠŸèƒ½èŒƒå›´

- [x] GitHub OAuth ç™»å½• (via Clerk)
- [x] Google OAuth ç™»å½• (via Clerk)
- [ ] é‚®ç®±å¯†ç ç™»å½•ï¼ˆå¯é€‰ï¼‰
- [x] Session ç®¡ç† (Clerk)
- [x] JWT Token æœºåˆ¶ (Clerk)
- [x] ç™»å½•çŠ¶æ€æŒä¹…åŒ–
- [x] é€€å‡ºç™»å½•åŠŸèƒ½
- [x] ç”¨æˆ·æ•°æ®åŒæ­¥åˆ° Neon æ•°æ®åº“ (useUserSync hook)

### æŠ€æœ¯è¦ç‚¹

```typescript
// æ¨èæ–¹æ¡ˆï¼šAuth.js (NextAuth) æˆ– Clerk
// å¦‚æœä½¿ç”¨ Auth.js:
pnpm add next-auth @auth/drizzle-adapter

// å¦‚æœä½¿ç”¨ Clerk:
pnpm add @clerk/clerk-react
```

### å¼€å‘æ­¥éª¤

1. é€‰æ‹©å¹¶é›†æˆ Auth æœåŠ¡
2. é…ç½® OAuth åº”ç”¨ï¼ˆGitHub/Googleï¼‰
3. å®ç°ç™»å½•/æ³¨å†Œé¡µé¢
4. æ·»åŠ å—ä¿æŠ¤è·¯ç”±
5. å®ç°ç”¨æˆ·ä¿¡æ¯å±•ç¤º
6. æ·»åŠ é€€å‡ºç™»å½•åŠŸèƒ½

### éªŒæ”¶æ ‡å‡†

- [x] GitHub OAuth ç™»å½•æˆåŠŸ
- [x] Google OAuth ç™»å½•æˆåŠŸ
- [x] ç”¨æˆ·ä¿¡æ¯æ­£ç¡®å­˜å‚¨åˆ°æ•°æ®åº“
- [x] åˆ·æ–°é¡µé¢åç™»å½•çŠ¶æ€ä¿æŒ
- [x] é€€å‡ºç™»å½•æ­£å¸¸å·¥ä½œ

---

## 3ï¸âƒ£ AI æ‰§è¡Œå®¹é”™æ€§æå‡

**åˆ†æ”¯**: `feature/ai-error-handling`

**çŠ¶æ€**: ğŸŸ¡ å¼€å‘ä¸­ (æ ¸å¿ƒå·²å®Œæˆ)

### åŠŸèƒ½èŒƒå›´

- [x] æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ + Jitterï¼‰
- [ ] è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
- [ ] è¿›åº¦åé¦ˆå¢å¼º
- [x] è¶…æ—¶æ™ºèƒ½å¤„ç†
- [x] é”™è¯¯åˆ†ç±»ä¸å‹å¥½æç¤º (åŸºç¡€å®ç°)
- [ ] ç½‘ç»œçŠ¶æ€æ£€æµ‹

### æŠ€æœ¯è¦ç‚¹

```typescript
/**
 * æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ç¤ºä¾‹
 */
const retryWithBackoff = async <T>(
	fn: () => Promise<T>,
	maxRetries: number = 3,
	baseDelay: number = 1000
): Promise<T> => {
	for (let i = 0; i < maxRetries; i++) {
		try {
			return await fn()
		} catch (error) {
			if (i === maxRetries - 1) throw error
			const delay = baseDelay * Math.pow(2, i)
			await new Promise((resolve) => setTimeout(resolve, delay))
		}
	}
	throw new Error('Max retries exceeded')
}
```

### å¼€å‘æ­¥éª¤

1. åˆ›å»ºç»Ÿä¸€çš„ API è¯·æ±‚å±‚
2. å®ç°é‡è¯•æœºåˆ¶
3. æ·»åŠ è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
4. å®ç°è¿›åº¦åé¦ˆ UI
5. æ·»åŠ é”™è¯¯ç±»å‹åˆ†ç±»
6. ç¼–å†™é”™è¯¯å¤„ç†å•å…ƒæµ‹è¯•

### éªŒæ”¶æ ‡å‡†

- [x] ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯• (withRetry å·²å®ç°)
- [ ] é‡è¯•è¿‡ç¨‹ä¸­æ˜¾ç¤ºè¿›åº¦
- [x] ä¸åŒé”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º (åŸºç¡€å®ç°)
- [ ] ç”¨æˆ·å¯ä»¥å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚

---

## ~~4ï¸âƒ£ ç”»æ¿å›¾å±‚ç³»ç»Ÿ~~ ğŸ“¦ å·²å½’æ¡£è‡³ P1

**åˆ†æ”¯**: `feature/canvas-layer-system`

**çŠ¶æ€**: ğŸ“¦ å½’æ¡£è‡³ P1

> [!NOTE]
> è¯¥åŠŸèƒ½å·²ç§»è‡³ P1 é˜¶æ®µå¼€å‘ã€‚P0 é˜¶æ®µèšç„¦äºæ ¸å¿ƒæ•°æ®åŸºç¡€è®¾æ–½å’ŒåŸºç¡€ä½“éªŒã€‚

### åŠŸèƒ½èŒƒå›´

- [ ] å¤šå›¾å±‚æ”¯æŒ
- [ ] å›¾å±‚æ·»åŠ /åˆ é™¤
- [ ] å›¾å±‚é¡ºåºè°ƒæ•´
- [ ] å›¾å±‚é”å®š/è§£é”
- [ ] å›¾å±‚æ˜¾ç¤º/éšè—
- [ ] å›¾å±‚é€æ˜åº¦è°ƒèŠ‚
- [ ] å›¾å±‚æ··åˆæ¨¡å¼ï¼ˆå¯é€‰ï¼‰

### æŠ€æœ¯è¦ç‚¹

```typescript
interface Layer {
	id: string
	name: string
	visible: boolean
	locked: boolean
	opacity: number
	blendMode?: string
	canvas: OffscreenCanvas
}

interface LayerState {
	layers: Layer[]
	activeLayerId: string | null
	addLayer: () => void
	removeLayer: (id: string) => void
	reorderLayers: (fromIndex: number, toIndex: number) => void
	// ...
}
```

### å¼€å‘æ­¥éª¤

1. è®¾è®¡å›¾å±‚æ•°æ®ç»“æ„
2. å®ç°å›¾å±‚çŠ¶æ€ç®¡ç†ï¼ˆæ¨èä½¿ç”¨ Zustandï¼‰
3. åˆ›å»ºå›¾å±‚é¢æ¿ UI
4. å®ç°å›¾å±‚åˆæˆæ¸²æŸ“
5. æ·»åŠ å›¾å±‚æ“ä½œäº¤äº’
6. å®ç°æ’¤é”€/é‡åšæ”¯æŒ

### éªŒæ”¶æ ‡å‡†

- [ ] å¯ä»¥åˆ›å»ºå¤šä¸ªå›¾å±‚
- [ ] å›¾å±‚å¯ä»¥é‡æ–°æ’åº
- [ ] å›¾å±‚é”å®šåæ— æ³•ç¼–è¾‘
- [ ] å›¾å±‚éšè—åä¸æ˜¾ç¤º
- [ ] å¯¼å‡ºæ—¶æ­£ç¡®åˆæˆæ‰€æœ‰å¯è§å›¾å±‚

---

## ~~5ï¸âƒ£ å±€éƒ¨é‡ç»˜åŠŸèƒ½ (Inpainting)~~ ğŸ“¦ å·²å½’æ¡£è‡³ P1

**åˆ†æ”¯**: `feature/inpainting`

**çŠ¶æ€**: ğŸ“¦ å½’æ¡£è‡³ P1

**ä¾èµ–**: `feature/canvas-layer-system`, `feature/ai-error-handling`

> [!NOTE]
> è¯¥åŠŸèƒ½å·²ç§»è‡³ P1 é˜¶æ®µå¼€å‘ã€‚ç”±äºä¾èµ–å›¾å±‚ç³»ç»Ÿï¼Œè®¡åˆ’åœ¨ P1 é˜¶æ®µä¸€å¹¶å®ç°ã€‚

### åŠŸèƒ½èŒƒå›´

- [ ] é€‰åŒºå·¥å…·ï¼ˆçŸ©å½¢/è‡ªç”±é€‰åŒºï¼‰
- [ ] é€‰åŒºè’™ç‰ˆç”Ÿæˆ
- [ ] å±€éƒ¨é‡ç»˜ API è°ƒç”¨
- [ ] é‡ç»˜ç»“æœåˆæˆ
- [ ] é€‰åŒºè¾¹ç¼˜ç¾½åŒ–ï¼ˆå¯é€‰ï¼‰

### æŠ€æœ¯è¦ç‚¹

```typescript
/**
 * Inpainting è¯·æ±‚å‚æ•°
 */
interface InpaintingRequest {
	originalImage: string // base64
	maskImage: string // base64ï¼Œé€‰åŒºè’™ç‰ˆ
	prompt: string
	negativePrompt?: string
}
```

### å¼€å‘æ­¥éª¤

1. å®ç°é€‰åŒºå·¥å…·
2. ç”Ÿæˆé€‰åŒºè’™ç‰ˆå›¾åƒ
3. è°ƒç”¨æ”¯æŒ inpainting çš„ AI æ¨¡å‹
4. å°†ç”Ÿæˆç»“æœåˆæˆåˆ°åŸå›¾
5. æ·»åŠ è¾¹ç¼˜å¤„ç†ä¼˜åŒ–

### éªŒæ”¶æ ‡å‡†

- [ ] å¯ä»¥åˆ›å»ºé€‰åŒº
- [ ] é€‰åŒºå†…å®¹å¯ä»¥é‡æ–°ç”Ÿæˆ
- [ ] é€‰åŒºå¤–å†…å®¹ä¿æŒä¸å˜
- [ ] ç”Ÿæˆç»“æœä¸åŸå›¾è‡ªç„¶èåˆ

---

## 6ï¸âƒ£ è‰ç¨¿è‡ªåŠ¨ä¿å­˜

**åˆ†æ”¯**: `feature/auto-save-draft`

**çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

**ä¾èµ–**: `feature/neon-database`, `feature/user-auth`

### åŠŸèƒ½èŒƒå›´

- [x] æœ¬åœ°è‡ªåŠ¨ä¿å­˜ï¼ˆIndexedDBï¼‰
- [ ] äº‘ç«¯è‡ªåŠ¨åŒæ­¥ï¼ˆç™»å½•ç”¨æˆ·ï¼‰- P1 å¯é€‰
- [x] è‰ç¨¿æ¢å¤æç¤º
- [ ] è‰ç¨¿ç®¡ç†ç•Œé¢ - P1 å¯é€‰
- [x] ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨

### æŠ€æœ¯è¦ç‚¹

```typescript
/**
 * å·²å®ç°ï¼šä½¿ç”¨ idb åº“è€Œé Dexie.js
 */
interface Draft {
	id: string
	canvasData: string // ReactSketchCanvas è·¯å¾„æ•°æ®ï¼ˆJSONï¼‰
	styleId: string
	prompt?: string
	thumbnailBlob?: Blob
	createdAt: number
	updatedAt: number
	syncedAt?: number
	userId?: string
}

// å®é™…ä½¿ç”¨ï¼špnpm add use-debounce
```

### å¼€å‘æ­¥éª¤

1. âœ… è®¾è®¡è‰ç¨¿æ•°æ®ç»“æ„
2. âœ… å®ç°æœ¬åœ°å­˜å‚¨ï¼ˆIndexedDBï¼‰- `draft-db.ts`
3. âœ… æ·»åŠ è‡ªåŠ¨ä¿å­˜è§¦å‘é€»è¾‘ - `use-drafts.ts`ï¼ˆ2 ç§’é˜²æŠ–ï¼‰
4. â³ å®ç°äº‘ç«¯åŒæ­¥ï¼ˆç™»å½•ç”¨æˆ·ï¼‰- å¯é€‰ä¼˜åŒ–
5. âœ… æ·»åŠ è‰ç¨¿æ¢å¤æç¤º - `DraftRecoveryDialog`
6. â³ åˆ›å»ºè‰ç¨¿ç®¡ç†ç•Œé¢ - å¯é€‰ä¼˜åŒ–

### éªŒæ”¶æ ‡å‡†

- [x] ç¼–è¾‘æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼ˆ2 ç§’é˜²æŠ–ï¼‰
- [ ] ç™»å½•ç”¨æˆ·è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼ˆP1 å¯é€‰ï¼‰
- [x] æ„å¤–å…³é—­åå¯æ¢å¤è‰ç¨¿
- [ ] å¯ä»¥ç®¡ç†å¤šä¸ªè‰ç¨¿ï¼ˆP1 å¯é€‰ï¼‰

---

## ğŸ“Š è¿›åº¦è¿½è¸ª

| åŠŸèƒ½            | è¿›åº¦ | çŠ¶æ€        | å…³é”®å®ç°                          |
| --------------- | ---- | ----------- | --------------------------------- |
| Neon æ•°æ®åº“é›†æˆ | 100% | âœ… å·²å®Œæˆ   | Drizzle ORM + Schema + Repository |
| ç”¨æˆ·è®¤è¯ç³»ç»Ÿ    | 100% | âœ… å·²å®Œæˆ   | Clerk + useUserSync               |
| AI æ‰§è¡Œå®¹é”™æ€§   | 70%  | ğŸŸ¡ å¼€å‘ä¸­   | withRetry + æµ‹è¯•é€šè¿‡              |
| ç”»æ¿å›¾å±‚ç³»ç»Ÿ    | 0%   | â¬œ æœªå¼€å§‹   | -                                 |
| å±€éƒ¨é‡ç»˜åŠŸèƒ½    | 0%   | â¬œ æœªå¼€å§‹   | ä¾èµ–å›¾å±‚ç³»ç»Ÿ                      |
| è‰ç¨¿è‡ªåŠ¨ä¿å­˜    | 95%  | âœ… æ ¸å¿ƒå®Œæˆ | draft-db + use-drafts + UI ç»„ä»¶   |

---

## ğŸ“… æ›´æ–°æ—¥å¿—

| æ—¥æœŸ       | æ›´æ–°å†…å®¹                                               |
| ---------- | ------------------------------------------------------ |
| 2026-01-04 | å®Œæˆè‰ç¨¿è‡ªåŠ¨ä¿å­˜æ ¸å¿ƒåŠŸèƒ½ï¼ˆæœ¬åœ°å­˜å‚¨+è‡ªåŠ¨ä¿å­˜+æ¢å¤æç¤ºï¼‰ |
| 2026-01-04 | æ›´æ–°è¿›åº¦ï¼šæ•°æ®åº“+è®¤è¯å·²å®Œæˆï¼ŒAI å®¹é”™æ ¸å¿ƒå·²å®ç°         |
| 2026-01-03 | åˆå§‹åŒ– P0 é˜¶æ®µå¼€å‘æŒ‡å—                                 |
